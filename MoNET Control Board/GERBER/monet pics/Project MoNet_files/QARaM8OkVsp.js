if (self.CavalryLogger) { CavalryLogger.start_js(["oAiuG"]); }

__d('MessengerQuickCamStore',['invariant','AsyncRequest','DOMQuery','FluxReduceStore','immutable','MercuryMessageActions','MercuryMessageObject','MercurySourceType','MessengerQuickCamActions','MessengerQuickCamConfig','MessengerQuickCamDispatcher','MessengerQuickCamOrigins','XMessagingQuickCamUploadController'],(function a(b,c,d,e,f,g,h){'use strict';var i,j,k,l;if(c.__markCompiled)c.__markCompiled();var m=c('MessengerQuickCamActions').Types;i=babelHelpers.inherits(n,c('immutable').Record({mediaRequested:false,quickcam:null,progressInterval:null,progressWidth:0,snapshot:null,source:null,threadID:null,uploadComplete:false,uploadError:false,videoBlob:null,videoRecorder:null,videoSrc:null,videoStream:null,viewer:null}));j=i&&i.prototype;function n(){i.apply(this,arguments);}k=babelHelpers.inherits(o,c('FluxReduceStore'));l=k&&k.prototype;o.prototype.getInitialState=function(){return new n();};o.prototype.reduce=function(p,q){switch(q.type){case m.CLOSE:return this.$MessengerQuickCamStore1(p);case m.REQUEST_USER_MEDIA:var r=q.threadID,s=q.viewer;p=p.merge({threadID:r,viewer:s});this.$MessengerQuickCamStore2(p);return p;case m.PROCESS_RECORDING:return this.$MessengerQuickCamStore3(p,q.videoBlob);case m.REGISTER_QUICKCAM:var t=q.source,u=q.quickcam;return p.merge({source:t,quickcam:u});case m.RETAKE:if(p.quickcam){var v=c('DOMQuery').find(p.quickcam,'video');v.muted=true;}return p.merge({snapshot:null,videoBlob:null});case m.SEND_PHOTO:return this.$MessengerQuickCamStore4(p);case m.SEND_VIDEO:if(p.quickcam){var w=c('DOMQuery').find(p.quickcam,'video');w.pause();}return this.$MessengerQuickCamStore5(p);case m.SET_MEDIA:var x=q.videoSrc,y=q.videoStream;return p.merge({mediaRequested:true,videoSrc:x,videoStream:y});case m.STOP_VIDEO:return this.$MessengerQuickCamStore6(p);case m.TAKE_PHOTO:return this.$MessengerQuickCamStore7(p);case m.TAKE_VIDEO:return this.$MessengerQuickCamStore8(p);case m.UPDATE_PROGRESS:return this.$MessengerQuickCamStore9(p);case m.UPLOAD_ERROR:return this.$MessengerQuickCamStore10(p,q.error);case m.UPLOAD_COMPLETE:var z=q.data;if(z&&z.payload)return this.$MessengerQuickCamStore11(p,z.payload);return p;case m.USER_MEDIA_ERROR:return p.set('mediaRequested',true);default:return p;}};o.prototype.$MessengerQuickCamStore8=function(p){var q;if(p.videoStream)(function(){var r=new window.MediaRecorder(p.videoStream),s=[];r.ondataavailable=function(x){s.push(x.data);};r.onstop=function(x){var y=new window.Blob(s,{type:'video/webm'});c('MessengerQuickCamActions').processRecording(y);};var t=c('MessengerQuickCamConfig').max_video_time,u=c('MessengerQuickCamConfig').progress_increment,v=t*u/100,w=setInterval(c('MessengerQuickCamActions').updateProgress,v);p=p.merge({videoRecorder:r,progressInterval:w});p.videoRecorder.start();})();return p;};o.prototype.$MessengerQuickCamStore6=function(p){if(p.videoRecorder)p.videoRecorder.stop();if(p.progressInterval){clearInterval(p.progressInterval);p=p.merge({progressInterval:null,progressWidth:0});}return p;};o.prototype.$MessengerQuickCamStore3=function(p,q){if(p.quickcam){var r=c('DOMQuery').find(p.quickcam,'video');r.muted=false;p=p.set('videoBlob',q);}return p;};o.prototype.$MessengerQuickCamStore2=function(p){var q=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;!q?h(0):void 0;q.call(navigator,{video:true,audio:true},function(r){if(r.getVideoTracks().length>0){c('MessengerQuickCamActions').setMedia(window.URL.createObjectURL(r),r);}else c('MessengerQuickCamActions').userMediaError();},function(r){c('MessengerQuickCamActions').userMediaError();});};o.prototype.$MessengerQuickCamStore7=function(p){if(p.quickcam){var q=c('DOMQuery').find(p.quickcam,'video'),r=c('DOMQuery').find(p.quickcam,'canvas');if(q&&r){r.height=q.videoHeight;r.width=q.videoWidth;var s=r.getContext('2d');if(s){s.translate(r.width,0);s.scale(-1,1);s.drawImage(q,0,0,r.width,r.height);p=p.set('snapshot',r.toDataURL());}}}return p;};o.prototype.$MessengerQuickCamStore9=function(p){if(p.progressWidth>=100)return this.$MessengerQuickCamStore6(p);if(p.quickcam)p=p.set('progressWidth',p.progressWidth+.01);return p;};o.prototype.$MessengerQuickCamStore4=function(p){if(p.snapshot&&p.quickcam){var q=p.quickcam,r=p.snapshot.split(',')[1],s=new FormData();s.append('bmp_string',r);s.append('async_response',true);this.$MessengerQuickCamStore12(q,s);}return p;};o.prototype.$MessengerQuickCamStore5=function(p){if(p.videoBlob&&p.quickcam){var q=new FileReader();q.readAsDataURL(p.videoBlob);q.onloadend=function(){var r=p.quickcam,s=new FormData();s.append('video_string',q.result.split(',')[1]);s.append('async_response',true);if(r)this.$MessengerQuickCamStore12(r,s);}.bind(this);}return p;};o.prototype.$MessengerQuickCamStore12=function(p,q){var r=c('DOMQuery').find(p,'[id="spinner"]'),s=c('XMessagingQuickCamUploadController').getURIBuilder().getURI(),t=new (c('AsyncRequest'))().setURI(s).setRawData(q).setStatusElement(r).setAllowCrossOrigin(true).setErrorHandler(function(u){return c('MessengerQuickCamActions').uploadError(u);}).setHandler(function(u){return c('MessengerQuickCamActions').uploadComplete(u);});t.send();};o.prototype.$MessengerQuickCamStore10=function(p,q){return p;};o.prototype.$MessengerQuickCamStore11=function(p,q){var r=p,s=r.threadID,t=r.viewer,u=r.source;if(t&&s&&u){var v=c('MercuryMessageObject').getForFBID(t),w=c('MercuryMessageActions').getForFBID(t),x=v.constructAttachmentMessageObject(u===c('MessengerQuickCamOrigins').MESSENGER?c('MercurySourceType').MESSENGER_WEB:c('MercurySourceType').CHAT_WEB,s),y={message_source:'camera'};x.message_source_data=JSON.stringify(y);x.body='';x.has_attachment=true;if(q.photo_fbid)x.photo_fbids=[q.photo_fbid.toString()];if(q.video_fbid)x.video_ids=[q.video_fbid.toString()];w.send(x);p=p.set('uploadComplete',true);}return p;};o.prototype.$MessengerQuickCamStore1=function(p){if(p.quickcam){var q=c('DOMQuery').find(p.quickcam,'video');q.src='';}if(p.progressInterval)clearInterval(p.progressInterval);var r=p.videoStream;if(r){r.getVideoTracks().forEach(function(s){s.stop();});r.getAudioTracks().forEach(function(s){s.stop();});}if(p.videoSrc)window.URL.revokeObjectURL(p.videoSrc);return this.getInitialState();};function o(){k.apply(this,arguments);}f.exports=new o(c('MessengerQuickCamDispatcher'));}),null);